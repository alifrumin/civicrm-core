# CiviCRM 5.2.0

Released June 6, 2018

- **[Synopsis](#synopsis)**
- **[Features](#features)**
- **[Bugs resolved](#bugs)**
- **[Miscellany](#misc)**
- **[Credits](#credits)**
- **[Feedback](#feedback)**

## <a name="synopsis"></a>Synopsis

| *Does this version...?*                                         |         |
|:--------------------------------------------------------------- |:-------:|
| Fix security vulnerabilities?                                   |         |
| Change the database schema?                                     |         |
| Alter the API?                                                  | **yes** |
| Require attention to configuration options?                     |         |
| Fix problems installing or upgrading to a previous version?     |         |
| Introduce features?                                             | **yes** |
| Fix bugs?                                                       | **yes** |

## <a name="features"></a>Features

### Core CiviCRM

- **[CRM-21849](https://issues.civicrm.org/jira/browse/CRM-21849) Add Link To
  Edit Relationship Types
  ([11853](https://github.com/civicrm/civicrm-core/pull/11853))**

  This change adds a settings button next to the Relationship Type field on the
  Edit Relationship screen which allows you to edit relationship types.

- **[dev/core#90](https://lab.civicrm.org/dev/core/issues/90) Apply disabling
  Full Group By to reports
  ([12047](https://github.com/civicrm/civicrm-core/pull/12047),
  [12043](https://github.com/civicrm/civicrm-core/pull/12043))**

  This applies the disabling of ONLY_FULL_GROUP_BY sql mode to reports and on
  specific queries as needed to enable tests to run on MySQL5.7

- **Add New API Call To Get All Unique Fields For Given Entity
  ([11990](https://github.com/civicrm/civicrm-core/pull/11990))**

  This adds a new api that will go through the indexes of an entity table and
  return all unique fields (including combination indexes).

- **[dev/core#66](https://lab.civicrm.org/dev/core/issues/66) Standardise
  Address code in Contact summary report & enable links
  ([11993](https://github.com/civicrm/civicrm-core/pull/11993))**

  This change refactors the Address related code as part of a drive to get addresses
  for multiple contacts in one report (relationship), more specifically this
  adds prefixing into the function used to add the columns. Approach is taken
  from extended reports.

- **[dev/translation#9](https://lab.civicrm.org/dev/translation/issues/9) Create
  API Action to rebuild Multilingual Schema
  ([11967](https://github.com/civicrm/civicrm-core/pull/11967))**

  This change adds an API tool to allow users to rebuild the multilingual
  schema. Before this users had to use cli tools to rebuild the multilingual
  schema now they are able to rebuild the schema using the API.

- **Add 'addToDeveloperTab' in more places to expose sql in use (permission
  limited) ([11947](https://github.com/civicrm/civicrm-core/pull/11947))**

  This change exposes more queries that take place for logging/summary if the user
  has permission to see the developer tab in civireport.

- **Fix API template ([11970](https://github.com/civicrm/civicrm-core/pull/11970))**

  This PR fixes structure and style of CiviCRM API explorer to make it look like
  other pages to give unified interface between screens.

### CiviMail

- **[dev/core#53](https://lab.civicrm.org/dev/core/issues/53) Add in stats to AB
  tests and add in clickthrough and opened % stats to mailing reports
  ([11957](https://github.com/civicrm/civicrm-core/pull/11957))**

  This change adds Mailing delivery stat percentages to AB tests and also adds
  in new opened and clickthrough rate stats.

### Dedupe

- **[CRM-21753](https://issues.civicrm.org/jira/browse/CRM-21753) Support
  'criteria' in url on batch merge form
  ([11658](https://github.com/civicrm/civicrm-core/pull/11658))**

  CiviCRM supports 'criteria' in batch merge - this PR ensures that if $criteria are in
  the url  on the find duplicates screen it is passed through to the merge
  function. This is part of the work towards extensionising dedupe functionality.

### CiviEvent

- **[CRM-20879](https://issues.civicrm.org/jira/browse/CRM-20879) Extend
  self-service event registration transfer to backend
  ([10695](https://github.com/civicrm/civicrm-core/pull/10695))**

  This change adds links to "Transfer or Cancel" an event registration when
  viewing an Event Registration for a participant and when viewing a contact's
  event registrations from the event tab on the contact's record.

### CiviContribute

- **[dev/core#73](https://lab.civicrm.org/dev/core/issues/73) - Add invoice
  number to bookkeeping report
  ([12020](https://github.com/civicrm/civicrm-core/pull/12020))**

  This change adds the invoice number to bookkeeping report. Before this change
  only Invoice ID was shown as a column in bookkeeping report now Invoice Number
  and Invoice Reference are both exposed in bookkeeping report.

## <a name="bugs"></a>Bugs resolved

### Core CiviCRM

- **[dev/core#98](https://lab.civicrm.org/dev/core/issues/98) Searching by any
  Address fields with location type other than primary throw DB error
  ([12081](https://github.com/civicrm/civicrm-core/pull/12081))**

  This change fixes a bug where when using Search Builder when a user picks an
  address field with a location type other than primary (Home for example),
  submit would result in a database error so that no fatal error is thrown and
  the correct results are shown.

- **[dev/core#91](https://lab.civicrm.org/dev/core/issues/91) Search Builder
  Improvements ([12058](https://github.com/civicrm/civicrm-core/pull/12058))**

   On the Search Builder screen, this change limits the MySql operators available
   based on the type of field (string, date etc.).

 - **Mark Accent String Tests as incomplete if on a database that is not utf8
   ([12060](https://github.com/civicrm/civicrm-core/pull/12060))**

   This PR fixes a bug where tests completely fail on latin1 test boxes so that
   tests are marked as incomplete rather than skipped.

- **[dev/core#75](https://lab.civicrm.org/dev/core/issues/75) - warning message
  after an activity is created
  ([12027](https://github.com/civicrm/civicrm-core/pull/12027))**

   This removes a Warning message "Warning: in_array() expects parameter 2 to be
   array, null given in CRM_Activity_Form_Activity->processActivity()..." that was
   being displayed after an activity was created.

- **translate strings
  ([11988](https://github.com/civicrm/civicrm-core/pull/11988))**

  This change adds translation (ts()) on an assortment of strings.

- **Translate strings in "Report" UI, et al
  ([12009](https://github.com/civicrm/civicrm-core/pull/12009))**

  This change adds translation (ts()) on an assortment of strings. Most of the
  strings are the CiviReport forms (although there are a few others).

- **[dev/core#70](https://lab.civicrm.org/dev/core/issues/70) On any custom
  search 'Print selected rows' action doesn't retain columns/values
  ([12010](https://github.com/civicrm/civicrm-core/pull/12010))**

  This PR fixes a bug where when one goes to use the "Print selected rows"
  action on any custom search the columns are not populated so that they are
  printed correctly.

- **Improve input handling in get-cases AJAX API
  ([12017](https://github.com/civicrm/civicrm-core/pull/12017))**

  Changes case type id and status id to be 'CommaSeparatedIntegers' instead of
  'String' to improve input handling in get-cases AJAX API.

- **[CRM-19885](https://issues.civicrm.org/jira/browse/CRM-19885) Scheduled
  Reminders: lack of default form values leads to SQL syntax error
  ([11972](https://github.com/civicrm/civicrm-core/pull/11972))**

  This fixes a regression from CRM-19853 where some fields were changed to text
  input without defining default values. Specifically, the integer fields
  start_action_offset, repetition_frequency_interval, end_frequency_interval,
  which aren't required fields. Leaving these blank led to NULL values in the
  database, which then led to SQL syntax errors.

- **[dev/core#64](https://lab.civicrm.org/dev/core/issues/64) - In custom
  searches, column headings are being ignored
  ([12001](https://github.com/civicrm/civicrm-core/pull/12001))**

  This change fixes a regression where for custom searches - ones that come
  installed with core CiviCRM as well as user-defined ones - the column headings
  defined in the custom search code were being ignored. This issue began in
  CiviCRM 5.0.0.

- **Namespace exception in test
  ([11986](https://github.com/civicrm/civicrm-core/pull/11986))**

  This change fixes a fatal when running only some tests without the full suite.

- **Fix intermittant test bug ([11995](https://github.com/civicrm/civicrm-core/pull/11995))**

  Fixes a bug when running Contact phpunit tests.

- **[dev/core#48](https://lab.civicrm.org/dev/core/issues/48) Fix PDF Letter
  only generates a single letter when multiple contact IDs are specified
  ([11985](https://github.com/civicrm/civicrm-core/pull/11985))**

  This change fixes a bug where when multiple contact IDs are specified via
  print/merge task the PDFLetterCommon code overwrote them with a single contact
  ID of the logged in user. This means that only a single PDF letter is
  printed/generated. This PR only uses the logged in contact ID if not contact IDs
  have been specified.

- **[dev/core#59](https://lab.civicrm.org/dev/core/issues/59) scheduled reminder
  email validation
  ([11973](https://github.com/civicrm/civicrm-core/pull/11973))**

  This change makes it so that the email address field on the scheduled reminder
  form is validated, before this change a non-email value could be stored in the
  field which would result in a silent failure.

- **[CRM-20598](https://issues.civicrm.org/jira/browse/CRM-20598) Phone ext in
  profile edit messing with address
  ([11978](https://github.com/civicrm/civicrm-core/pull/11978))**

  This change fixes a bug where when using a profile in edit mode with "Phone and
  Extension" on primary field and some primary address fields (street, city,
  country) it works fine the first time the profile is used but removes the
  existing address when a user tries to use the profile a second time.

- **AllCoreTables - Generate file every time
  ([11755](https://github.com/civicrm/civicrm-core/pull/11755))**

  The autogenerated file AllCoreTables was not being updated as often as
  necessary, and the freshness checks were almost as expensive as just generating
  the file, if not more, this was causing issues for the Attachment API. This
  change makes it so the file is generated everytime.

- **Prevent hard-fail when section header / group by option chosen on logging
  report ([11953](https://github.com/civicrm/civicrm-core/pull/11953))**

  This change prevents a fatal error when the "section header / group by" option  is
  chosen on the logging report.

- **[CRM-21855](https://issues.civicrm.org/jira/browse/CRM-21855) Editing "A"
  side of relationship copies values to "B" side
  ([11965](https://github.com/civicrm/civicrm-core/pull/11965))**

  This change fixes a bug where when editing the "A" side of a relationship from
  'civicrm/admin/reltype' the values entered in the "Relationship A to B" column
  were copied to the "Relationship B to A" column.

- **Fix contribution detail report to work with FULL GROUP BY mode
  ([11954](https://github.com/civicrm/civicrm-core/pull/11954))**

  This PR makes it so the contribution detail report works in both full group by
  and non full group by mode.

- **[CRM-21523](https://issues.civicrm.org/jira/browse/CRM-21523) scheduled
  reminders: when using repetition, require frequency intervals
  ([11377](https://github.com/civicrm/civicrm-core/pull/11377))**

  This PR adds form rules to the schedule reminder form to require both frequency
  interval fields if repetition is enabled because if they are left blank it
  causes a SQL error when the scheduled reminder job is triggered.

### Dedupe

- **Move help section outside the container
  ([12031](https://github.com/civicrm/civicrm-core/pull/12031))**

  This PR moves help section outside of container on the dedupe find form to
  preserve consistency among other screens

### CiviEvent

- **Fix Soft credit personal note ton limit to 255 characters (DB limit).
  ([12056](https://github.com/civicrm/civicrm-core/pull/12056))**

  This change fixes a bug where when a user is donating on a civiEvent Personal
  Campaign page and checks the "Show my support in public honor roll" and puts a
  message in the "Personal Note" box that is longer than 255 characters submit
  the donation processes but the page throws a fatal error before receipt is
  dispatched - so donor does not now monies went through by changing he DB limit
  for the field soft credit personal note.

- **[dev/core#60](https://lab.civicrm.org/dev/core/issues/60) Fix for check
  number no longer exposed dev/core/issues/60
  ([12059](https://github.com/civicrm/civicrm-core/pull/12059))**

  This change fixes a bug where the "Check number" was not showing on Pay Later
  event registrations when edited.

- **Fix: Batch update participants with checkboxes fails
  ([12051](https://github.com/civicrm/civicrm-core/pull/12051))**

  This change fixes a bug where when doing a batch update of participants
  including a field that uses checkboxes the batch update fails.

- **[dev/core#65](https://lab.civicrm.org/dev/core/issues/65) Fix issue where
  source for participant could be entered w…
  ([12014](https://github.com/civicrm/civicrm-core/pull/12014))**

  This change fixes a bug where when one attempted to manually add a participant
  to an event using the "Add event registration" tab on their CiviCRM profile, but
  the screen wouldn't save, the page just stays frozen and fails to complete.

### CiviCase

- **[CRM-21843](https://issues.civicrm.org/jira/browse/CRM-21843) Case
  activities delimiter not working
  ([11961](https://github.com/civicrm/civicrm-core/pull/11961))**

  This change fixes a bug where when exporting Cases The last column would contain
  all the activity fields jammed together.

- **Add missing case type tests
  ([12023](https://github.com/civicrm/civicrm-core/pull/12023))**

  This PR adds a few tests that are missing for the caseTypeListCtrl controller.

- **Fix select2 value updation for crmAddName Directive
  ([11979](https://github.com/civicrm/civicrm-core/pull/11979))**

  This PR fixes a bug where the Case Type options select2 was not populating
  properly.

- **[dev/core#54](https://lab.civicrm.org/dev/core/issues/54) - Activity created
  for case role relationship is not assigned to correct contact
  ([11960](https://github.com/civicrm/civicrm-core/pull/11960))**

  This change fixes a bug where if the user added a role for a case. The activity
  created was assigned to the client instead of the relationship contact.

### CiviContribute

- **[dev/core#78](https://lab.civicrm.org/dev/core/issues/78) - Incorrect
  Payment Processor for Recurring Payments
  ([12030](https://github.com/civicrm/civicrm-core/pull/12030))**

  This PR fixes a bug where the incorrect payment processor was being used for
  recurring payments. The issue arose due to there being two AuthNet payment
  processors, one for both A1 and A2. And the CiviCRM code is (naively) written
  assuming there'd be a maximum of one. So when AuthNet calls into CiviCRM to
  notify it of a successful recurring payment, for the A1 payments it was loading
  the A2 payment processor — and then failing.

- **[dev/core#72](https://lab.civicrm.org/dev/core/issues/72) fix payflow bug
  for amount ([12019](https://github.com/civicrm/civicrm-core/pull/12019))**

  Fixes a bug where PayflowPro throws an error due to more than 4 decimal places
  in the amount.

- **[CRM-19752](https://issues.civicrm.org/jira/browse/CRM-19752) Slow query
  created by financial type acls
  ([11657](https://github.com/civicrm/civicrm-core/pull/11657))**

  This change is to improve Financial ACL code that was unnecessarily slowing down
  the contact dashboard on sites where Finacial ACL's are not enabled by making it
  so the Financial ACL join & condition is not added where financial acls are not
  enabled.

- **[dev/financial#11](https://lab.civicrm.org/dev/financial/issues/11) email
  invoice fails with validation error
  ([11971](https://github.com/civicrm/civicrm-core/pull/11971))**

  This change fixes a bug where when invoicing was enabled, the "Email Invoice"
  option would result in an outgoing error message: The mail library returned the
  following error message: Validation failed for: ""NAME"".

- **Fix template for widget
  ([11902](https://github.com/civicrm/civicrm-core/pull/11902))**

  This PR fixes glitches in the Contribution Widget template so that the button is
  aligned properly under it.

- **Remove usage of deprecated paymentProcessorType function
  ([12039](https://github.com/civicrm/civicrm-core/pull/12039))**

  This cleans up and removes usage of deprecated
  CRM_Core_PseudoConstant::paymentProcessorType in favour of standard
  getKey/getName functions. Duplicated code from getPayment is also removed and
  consolidated into a single function.

### CiviMail

- **[CRM-21194](https://issues.civicrm.org/jira/browse/CRM-21194) Unique clicks
  in mailing report shows duplicates
  ([10988](https://github.com/civicrm/civicrm-core/pull/10988))**

  Ensure Mailing Report displays unique URL clicks in a mailing and does not show
  the same person twice.

- **[CRM-21100](https://issues.civicrm.org/jira/browse/CRM-21100) Empty list
  shown in "Send test email to group" dropdown
  ([10898](https://github.com/civicrm/civicrm-core/pull/10898))**

  In the preview section of a mailing, the "Send test email to groups" dropdown
  showed an empty list by default. This change makes it so the list is now only
  populated by the current list of recipients, if any. It should list existing
  groups even though these are not chosen as recipients. Previously the Test Group
  box was generated using a list of groups put into the DOM. Now it works off an
  AJAX based API call in the same style as the Recipients box.

- **[dev/core#86](https://lab.civicrm.org/dev/core/issues/86) Notify admin when
  testing email if CIVICRM_MAIL_LOG_AND_SEND is set
  ([12037](https://github.com/civicrm/civicrm-core/pull/12037))**

  When CIVICRM_MAIL_LOG_AND_SEND is set the admin is not notified if it is set,
  but they are if CIVICRM_MAIL_LOG is set. With this PR they are notified if
  either is set

- **[dev/core#86](https://lab.civicrm.org/dev/core/issues/86)Fix typo in
  CIVICRM_MAIL_LOG_AND_SEND constants
  ([204](https://github.com/civicrm/civicrm-packages/pull/204))**

  This fixes a bug where in the packages/Mail "CIVICRM_MAIL_LOG_AND_SEND" is
  mistyped as "CIVICRM_MAIL_LOG_AND SEND" (ie. missing an underscore) so in
  CiviCRM core the administrator was not notified if it is set.

### WordPress Integration

- **[CRM-21564](https://issues.civicrm.org/jira/browse/CRM-21564) Changing from
  using exec to WP_CLI::Launch
  ([119](https://github.com/civicrm/civicrm-wordpress/pull/119))**

  This change moves from using exec to WP_CLI:: Launch because exec does not seem
  to be available on all systems it also makes the code more consistent for
  running external processes.

### Drupal integration

- **Fix the contact merge form on Drupal 8
  ([11992](https://github.com/civicrm/civicrm-core/pull/11992))**

  This fixes a bug with Drupal 8 integrations where attempting to merge contacts
  which are associated with Drupal users resulted in a fatal error.

- **Drupal8 loadBootStrap: fix user variable
  ([11958](https://github.com/civicrm/civicrm-core/pull/11958))**

  This fixes an "errof 500" when sending requests to the REST API endpoint
  because of an incorrectly referenced variable.

## <a name="misc"></a>Miscellany

- **[CRM-21037](https://issues.civicrm.org/jira/browse/CRM-21037) Add unit tests
  for Activity sendSMS functions
  ([10946](https://github.com/civicrm/civicrm-core/pull/10946))**

- **[CRM-21148](https://issues.civicrm.org/jira/browse/CRM-21148) Refactor
  "getFromTo()" functions
  ([11887](https://github.com/civicrm/civicrm-core/pull/11887))**

- **Fix (unreleased) regression on report pager
  ([12080](https://github.com/civicrm/civicrm-core/pull/12080))**

- **[NFC] FIx indenting in eventFees template
  ([12062](https://github.com/civicrm/civicrm-core/pull/12062))**

- **[NFC] Add metadata to describe personal note field
  ([12046](https://github.com/civicrm/civicrm-core/pull/12046))**

- **(NFC) Update version in header
  ([11999](https://github.com/civicrm/civicrm-core/pull/11999))**

- **[nfc]  Consistently specify whether to clean money when calling from test
  suite ([11959](https://github.com/civicrm/civicrm-core/pull/11959))**

- **(NFC) Update version in header
  ([530](https://github.com/civicrm/civicrm-drupal/pull/530))**

- **(NFC) Fix Warnings When Updating Custom Entities
  ([12033](https://github.com/civicrm/civicrm-core/pull/12033))**

- **(NFC) Update version headers in `xml`, `tests`, `tools`, et al
  ([12029](https://github.com/civicrm/civicrm-core/pull/12029))**

- **5.1 ([12018](https://github.com/civicrm/civicrm-core/pull/12018))**

- **[CRM-20459](https://issues.civicrm.org/jira/browse/CRM-20459) Actively
  deprecate CRM_Core_OptionGroup::getValue
  ([12049](https://github.com/civicrm/civicrm-core/pull/12049))**

- **Rename function enableFullGroupByMode to be reenableFullGroupByMode t…
  ([12064](https://github.com/civicrm/civicrm-core/pull/12064))**

- **Remove unused code in CRM_Contribute_Form_ContributionPage_Amount::formRule
  ([12054](https://github.com/civicrm/civicrm-core/pull/12054))**

- **Add unit test to event batch update (includes function extraction to support
  this) ([12048](https://github.com/civicrm/civicrm-core/pull/12048))**

- **E-notice fix ([11982](https://github.com/civicrm/civicrm-core/pull/11982))**

- **Extract custom data edit template code to shared template
  ([11950](https://github.com/civicrm/civicrm-core/pull/11950))**

- **Simple function extraction on editing Address (within main contact edit)
  ([11900](https://github.com/civicrm/civicrm-core/pull/11900))**

- **Allow KCFinder to send back a json encoded response instead of string…
  ([203](https://github.com/civicrm/civicrm-packages/pull/203))**

## <a name="credits"></a>Credits

This release was developed by the following code authors:

AGH Strategies - Andrew Hunt; Australian Greens - Seamus Lee; CiviCoop - Jaap Jansma; CiviCRM - Coleman Watts, Tim Otten; CiviDesk - Yashodha Chaku; CompuCorp - Michael Devery, Mukesh Ram, René Olivo, Vinu Varshith Sekar; Coop SymbioTIC - Mathieu Lutfy, Samuel Vanhove; deb1990; Fuzion - Jitendra Purohit; JMA Consulting - Monish Deb; Lighthouse Design and Consulting - Brian Shaughnessy; Megaphone Technology Consulting - Jon Goldberg; MJW Consulting - Matthew Wire; myDropWizard - David Snopek; Progressive Technology Project - Jamie McClelland; TBSliver; Wikimedia Foundation - Eileen McNaughton

Most authors also reviewed code for this release; in addition, the following
reviewers contributed their comments:

aferreras; Australian Greens - Seamus Lee; Chris Burgess; Christian Wach; CiviCoop - Jaap Jansma, Klaas Eikelboom; civicrm-builder; CiviCRM - Coleman Watts; CiviDesk - Yashodha Chaku; CompuCorp - Michael Devery; Coop SymbioTIC - Mathieu Lutfy, Samuel Vanhove, Stéphane Lussier; deb1990; Donald Hirst; Fuzion - Peter Davis; gmcvo; JMA Consulting - Joe Murray, Monish Deb; Joinery - Allen Shaw; Left Join Labs - Sean Madsen; Lemniscus - Noah Miller; Lighthouse Design and Consulting - Brian Shaughnessy; Megaphone Technology Consulting - Jon Goldberg; MJW Consulting - Matthew Wire; myDropWizard - David Snopek; Nubay Services - David Tarrant; Pradeep Nayak; Progressive Technology Project - Jamie McClelland; Semper IT - Karin Gerritsen; small biz; Tadpole Collective - Kevin Cristiano; TBSliver; Third Sector Design - Michael McAndrew; Wikimedia Foundation - Eileen McNaughton

## <a name="feedback"></a>Feedback

These release notes are edited by Alice Frumin and Andrew Hunt.  If you'd like
to provide feedback on them, please login to https://chat.civicrm.org/civicrm
and contact `@agh1`.
