# CiviCRM 5.9.0

Released January 2, 2019

- **[Synopsis](#synopsis)**
- **[Features](#features)**
- **[Bugs resolved](#bugs)**
- **[Miscellany](#misc)**
- **[Credits](#credits)**
- **[Feedback](#feedback)**

## <a name="synopsis"></a>Synopsis

| *Does this version...?*                                         |         |
|:--------------------------------------------------------------- |:-------:|
| Fix security vulnerabilities?                                   |         |
| Change the database schema?                                     |         |
| Alter the API?                                                  | **yes** |
| Require attention to configuration options?                     | **yes** |
| Fix problems installing or upgrading to a previous version?     |         |
| Introduce features?                                             | **yes** |
| Fix bugs?                                                       | **yes** |

## <a name="features"></a>Features

### Core CiviCRM

- **[dev/core#217](https://lab.civicrm.org/dev/core/issues/217) Allow
  replacement of PrevNextCache implementation (for search screens)
  ([13168](https://github.com/civicrm/civicrm-core/pull/13168) and
  [12665](https://github.com/civicrm/civicrm-core/pull/12665))**

  This change makes it possible to use Redis to store the prev-next cache used
  by contact-search screens by updating the setting "PrevNext Cache" on the
  Administer -> Misc page.

- **[dev/core#561](https://lab.civicrm.org/dev/core/issues/561) Replace
  jcalendar instances with datepicker
  ([13206](https://github.com/civicrm/civicrm-core/pull/13206),
  [13208](https://github.com/civicrm/civicrm-core/pull/13208),
  [13203](https://github.com/civicrm/civicrm-core/pull/13203),
  [13196](https://github.com/civicrm/civicrm-core/pull/13196) and
  [13198](https://github.com/civicrm/civicrm-core/pull/13198)) - Continues Work
  Towards**

  These changes switch fields that store dates to use the datepicker instead of
  jcalendar in the following places: the pledge payment form, the tagged
  contributions custom search, the activity custom search form, the price field
  form and the Event Aggregate Custom search.

- **[dev/core#11](https://lab.civicrm.org/dev/core/issues/11) Email - send now
  error screen should display earlier
  ([13207](https://github.com/civicrm/civicrm-core/pull/13207))**

  From the results of an advanced search one can select the action option "Email -
  send now (to 50 or less)" this change improves user experience by throwing an
  error if a user tries to select more than 50 contacts and this action (when
  displaying the results as contributions or memberships).

- **[dev/core#505](https://lab.civicrm.org/dev/core/issues/505) Allow for
  Extensions to set the CRM Type and PHP Type when dealing with unusual MySQL
  Types ([13059](https://github.com/civicrm/civicrm-core/pull/13059))**

  This change makes it so that extension authors can specify phpType and crmType
  in their xml.

- **[dev/core#518](https://lab.civicrm.org/dev/core/issues/518) Lybunt
  performance improvement
  ([13088](https://github.com/civicrm/civicrm-core/pull/13088))**

  This change improves performance of the LYBUNT report.

## <a name="bugs"></a>Bugs resolved

### CiviCase

- **[dev/core#321](https://lab.civicrm.org/dev/core/issues/321) Prevent
  duplicate entries in civicrm_entity_file
  ([12650](https://github.com/civicrm/civicrm-core/pull/12650))**

  This change fixes a bug where editing a case activity with an attachment would
  result in a duplicate entry in the civicrm_entity_file table.

### CiviContribute

- **[dev/core#153](https://lab.civicrm.org/dev/core/issues/153) Pending Pay
  Later /w Custom payment method
  ([13098](https://github.com/civicrm/civicrm-core/pull/13098))**

  This change fixes a bug where using a custom payment method to make a pending
  pay later contribution would result in a contribution that one could not
  record payments against.

- **[dev/core#193](https://lab.civicrm.org/dev/core/issues/193) Order API Throw
  an error when adding tax amount on line items
  ([13091](https://github.com/civicrm/civicrm-core/pull/13091))**

  This change fixes a bug the Order API would fail when doing a create order
  with taxes enabled so that one can use the Order API to create with taxes
  enabled.

- **[dev/core#513](https://lab.civicrm.org/dev/core/issues/513) Contribution
  Transact API - Use the payment processor payment method instead of the
  payment_type field
  ([13073](https://github.com/civicrm/civicrm-core/pull/13073))**

  This change makes it so that the Contribute.Transact API bases the
  payment_instrument_id field off of the used payment processor
  payment_instrument_id instead of the payment_type field.

### CiviMail

- **[dev/core#498](https://lab.civicrm.org/dev/core/issues/498) Undefined index
  in mailing report for mailing_modified_date; and room for refactoring
  ([13194](https://github.com/civicrm/civicrm-core/pull/13194))**

  This change fixes an undefined index notice on the $mailing_modified_date that
  was showing up on all mailing reports.

### CiviMember

- **[dev/core#511](https://lab.civicrm.org/dev/core/issues/511) Membership
  Dashboard shows incorrect month
 ([13072](https://github.com/civicrm/civicrm-core/pull/13072))**

  This change ensures that the Membership Dashboard shows the correct current
  month.

### Core CiviCRM

- **[dev/core#125](https://lab.civicrm.org/dev/core/issues/125) Invalid link to
  custom-fields documentation
  ([13199](https://github.com/civicrm/civicrm-core/pull/13199))**

  This change fixes the link to the Custom Fields documentation on the Custom
  Group form to point to the correct documentation page.

- **[dev/core#371](https://lab.civicrm.org/dev/core/issues/371) Be
  environmentally friendly. Remove the sentence: "Please print this page for
  your records." from the various CiviCRM tpls. We like trees!
  ([13156](https://github.com/civicrm/civicrm-core/pull/13156))**

  This change removes the sentence "Please print this page for your records."
  from the Thank You page for online contribution and event registration pages.

- **[dev/core#372](https://lab.civicrm.org/dev/core/issues/372) 5.6.alpha1
  notice ([13079](https://github.com/civicrm/civicrm-core/pull/13079))**

  This change fixes a bug where editing an activity that had no details would
  result in a notice error so that no notice error is thrown.

- **[dev/core#406](https://lab.civicrm.org/dev/core/issues/406) 5.5.2: Import is
  not happy on PHP-7.2 (Countable)
  ([13133](https://github.com/civicrm/civicrm-core/pull/13133))**

  This change fixes a "PHP Warning:  count():" warning for users running php 7.2
  when importing.

- **[dev/core#407](https://lab.civicrm.org/dev/core/issues/407) Error with
  currency localization when recording a payment
  ([13226](https://github.com/civicrm/civicrm-core/pull/13226))**

  This change fixes a bug for users with a config with commas for the decimal
  place and dots for the thousand separators where saving price set information
  ON the membership tab for a contribution page would result in an error on
  save.

- **[dev/core#442](https://lab.civicrm.org/dev/core/issues/442) Misc form issues
  ([13197](https://github.com/civicrm/civicrm-core/pull/13197))**

  This change makes a variety of small styling improvements including: On the
  New Individual form, in the "Tags and Groups" section aligning the Tags and
  Groups boxes properly and using text inputs instead to text areas on the word
  replacements form.

- **[dev/core/482](https://lab.civicrm.org/dev/core/issues/482) New
  Organization: There is no possible to add another website after deleting
  ([13169](https://github.com/civicrm/civicrm-core/pull/13169)) -- Work
  towards**

  When adding a new contact via the "New Individual", "New Organization" etc
  forms, or editing a contact, the website blocks allow a user to delete a block
  even if it's the only one left. If one deletes the only website block the user
  is not able to re-create a website block. This is non-standard for this form
  i.e. Phone Number, Email, IM do not let a user delete a block if it's the only
  one left. This change makes it so like Phone Number, Email, and IM one cannot
  delete the last website block.

- **[dev/core#503](https://lab.civicrm.org/dev/core/issues/503) Editing Rich
  Text custom field on relationship non-functional
  ([13076](https://github.com/civicrm/civicrm-core/pull/13076))**

  This fixes a bug where editing a Note/RichTextEditor custom field on a
  relationship would result in the HTML tags being encoded into the content (and
  piling up each time one edits the field) so that the HTML tags to not get
  encoded.

- **[dev/core#525](https://lab.civicrm.org/dev/core/issues/525) Extraneous
  br-tags in rendered note-fields
  ([13101](https://github.com/civicrm/civicrm-core/pull/13101))**

  This change fixes a bug where note fields were being rendered with extra blank
  lines so that blank lines are not duplicated.

- **[dev/core#527](https://lab.civicrm.org/dev/core/issues/527) Non translatable
  fields in profile schema
  ([13110](https://github.com/civicrm/civicrm-core/pull/13110))**

  This change makes the "Public Title" field on the profile form translatable.

- **[dev/core#528](https://lab.civicrm.org/dev/core/issues/528) Advanced Search ->
  Contribution Tab and Contribution Dashboard returns a fatal error.
  ([13112](https://github.com/civicrm/civicrm-core/pull/13112))**

  This change fixes a bug where opening the Contributions tab on the Advanced
  Search would result in a network error.

- **[dev/core#529](https://lab.civicrm.org/dev/core/issues/529) Editing smart
  group removes search criteria unless criteria tabs are opened first
  ([13217](https://github.com/civicrm/civicrm-core/pull/13217))**

  This change ensures that when editing smart groups the previously selected
  criteria is respected regardless of whether or not the criteria tabs are
  opened first.

- **[dev/core#532](https://lab.civicrm.org/dev/core/issues/532) Multi-select
  field not respected in batch search
  ([13121](https://github.com/civicrm/civicrm-core/pull/13121))**

  This change ensures that on the Batch form one can pick multiple options for
  the field "Financial Type", before this change selecting multiple options for
  the "Financial Type" field would result in the search failing.

- **[dev/core#536](https://lab.civicrm.org/dev/core/issues/536) Contribution tab is slow to render for contacts with many contributions (in large database) ([13149](https://github.com/civicrm/civicrm-core/pull/13149))**

- **[dev/core#540](https://lab.civicrm.org/dev/core/issues/540) Civicrm Contact Dashboard returns fatal error ([13140](https://github.com/civicrm/civicrm-core/pull/13140))**

- **[dev/core#559](https://lab.civicrm.org/dev/core/issues/559) AngularJS module crmUi has an unstated dependency on ui.utils ([13180](https://github.com/civicrm/civicrm-core/pull/13180))**

- **[dev/core#563](https://lab.civicrm.org/dev/core/issues/563) Duplicate Case manager role ([13188](https://github.com/civicrm/civicrm-core/pull/13188))**

- **[dev-core#565](https://lab.civicrm.org/dev/core/issues/565) Make subject field of Note, inline editable in contact summary page  ([13190](https://github.com/civicrm/civicrm-core/pull/13190))**

- **[dev/core#573](https://lab.civicrm.org/dev/core/issues/573) State field displays too small ([13223](https://github.com/civicrm/civicrm-core/pull/13223))**

- **[dev/cloud-native/issues#18](https://lab.civicrm.org/dev/cloud-native/issues/18) Soften messages for read-only extensionsDir ([13100](https://github.com/civicrm/civicrm-core/pull/13100))**

- **Api3 - Add uf_user contact search param ([13230](https://github.com/civicrm/civicrm-core/pull/13230))**

- **Displayvalue fixes ([13175](https://github.com/civicrm/civicrm-core/pull/13175))**

- **Typos, simplify if statement ([13233](https://github.com/civicrm/civicrm-core/pull/13233))**

- **Add custom search handling for jcalendar converstion. ([13209](https://github.com/civicrm/civicrm-core/pull/13209))**

- **[CRM-19115](https://issues.civicrm.org/jira/browse/CRM-19115) PHP and MySQL timezones mismatch over API but not in UI ([13220](https://github.com/civicrm/civicrm-core/pull/13220) and [13218](https://github.com/civicrm/civicrm-core/pull/13218))**

- **Set default financial_type_id for creating new payment processors (form & api) ([13181](https://github.com/civicrm/civicrm-core/pull/13181))**

- **Make world_region translate on advanced search field ([13212](https://github.com/civicrm/civicrm-core/pull/13212))**

- **Prototype for metadata based fields on search screens. ([13013](https://github.com/civicrm/civicrm-core/pull/13013))**

- **Add \Civi\Token\TokenProcessor::getContextValues() ([13214](https://github.com/civicrm/civicrm-core/pull/13214))**

- **Remove '$dao->free()' part 1 ([13192](https://github.com/civicrm/civicrm-core/pull/13192))**

- **Prevent viewport jump when toggling help on "Administer CiviCRM" screen ([13173](https://github.com/civicrm/civicrm-core/pull/13173))**

- **Remove Defunct Templates from CiviMail ([13201](https://github.com/civicrm/civicrm-core/pull/13201))**

- **Update npm dependencies to fix audit issues ([13195](https://github.com/civicrm/civicrm-core/pull/13195))**

- **Flatten fix ([13176](https://github.com/civicrm/civicrm-core/pull/13176))**

- **Extract getContributionBalance function, use that rather than wrapper… ([13151](https://github.com/civicrm/civicrm-core/pull/13151))**

- **Fixes to enable UserDashboard tests to all run ([13147](https://github.com/civicrm/civicrm-core/pull/13147))**

- **Set currency template variable from contribution pages ([13157](https://github.com/civicrm/civicrm-core/pull/13157))**

- **Api3 profile:submit - fix handling of greeting fields ([13161](https://github.com/civicrm/civicrm-core/pull/13161))**

- **Avoid permission checking on getOrganizationNames ([13162](https://github.com/civicrm/civicrm-core/pull/13162))**

- **Fix Export when full group by mode is used ([13124](https://github.com/civicrm/civicrm-core/pull/13124))**

- **Lybunt report - improve developer support for debugging this report ([13087](https://github.com/civicrm/civicrm-core/pull/13087))**

- **Export code cleanup - only construct one metadata array with all types of metadata ([13126](https://github.com/civicrm/civicrm-core/pull/13126))**

- **Export code clean up - extract build row & getTransformed row off to ExportProcessor ([13117](https://github.com/civicrm/civicrm-core/pull/13117))**

- **Export code cleanup - Use getComponentPaymentFields from processorClass ([13082](https://github.com/civicrm/civicrm-core/pull/13082))**

- **Minor Contact BAO code cleanup ([13115](https://github.com/civicrm/civicrm-core/pull/13115))**

- **Update name of icon from pencil to wrench in EventInfo help ([13119](https://github.com/civicrm/civicrm-core/pull/13119))**

- **Fix Configure Event help grammar ([13118](https://github.com/civicrm/civicrm-core/pull/13118))**

- **Regression: Fix delete event participant fatal error and display name if no email ([13113](https://github.com/civicrm/civicrm-core/pull/13113))**

- **[CRM-21427](https://issues.civicrm.org/jira/browse/CRM-21427) Websites are removed from the contact if their type is empty ([13097](https://github.com/civicrm/civicrm-core/pull/13097))**

- **Use tab title in feedback message ([13102](https://github.com/civicrm/civicrm-core/pull/13102))**

- **Add format type to Case Start and End Dates ([13095](https://github.com/civicrm/civicrm-core/pull/13095))**

- **Activity tab code refactor ([12557](https://github.com/civicrm/civicrm-core/pull/12557))**

- **Add merge link to duplicate contact popup ([13081](https://github.com/civicrm/civicrm-core/pull/13081))**

- **Fix Job Log entries containing links so they will display properly ([12659](https://github.com/civicrm/civicrm-core/pull/12659))**

- **Fix accidental scroll when saving/deleting CiviMail draft ([13085](https://github.com/civicrm/civicrm-core/pull/13085))**

- **Trigger post hook on Event Copy ([12990](https://github.com/civicrm/civicrm-core/pull/12990))**

- **CRM_Core_I18n::setLocale should change $tsLocale for getLocale() to work correctly ([13050](https://github.com/civicrm/civicrm-core/pull/13050))**

- **Display message template title on deletion form ([13058](https://github.com/civicrm/civicrm-core/pull/13058))**

- **Fix metadata on cancel_reason so it is an exportable field ([12775](https://github.com/civicrm/civicrm-core/pull/12775))**

- **Upgrade to Quickform 3.2.16  ([224](https://github.com/civicrm/civicrm-packages/pull/224))**

- **Fix continue / break warning under PHP 7.3 ([228](https://github.com/civicrm/civicrm-packages/pull/228))**

- **Fix PHP7.2 warning when re-generating schema files ([232](https://github.com/civicrm/civicrm-packages/pull/232))**

- **Php 7.2 fix notice on countable ([229](https://github.com/civicrm/civicrm-packages/pull/229))**

- **Fix continue / break PHP 7.3 warnings ([13066](https://github.com/civicrm/civicrm-core/pull/13066))**

- **Fix php 7.2 notice ([13132](https://github.com/civicrm/civicrm-core/pull/13132))**

- **Fix php7.2 notices on trying to count null ([13111](https://github.com/civicrm/civicrm-core/pull/13111))**

- **Fix warning error on php 7.2 ([13107](https://github.com/civicrm/civicrm-core/pull/13107))**

### CiviMail

- **[CRM-19751](https://issues.civicrm.org/jira/browse/CRM-19751) Once "multiple
  bulk" setting, cannot search for opt out or on hold contacts
  ([12942](https://github.com/civicrm/civicrm-core/pull/12942))**

  For users with the setting "Enable multiple bulk email address for a contact"
  enabled this change updates the Advanced search form "Email On Hold" field to
  be a select that lists the Email on Hold options enabled by this setting
  ("No", "On Hold Bounce", "On Hold Opt Out"). Users with the setting "Enable
  multiple bulk email address for a contact" enabled should edit any existing
  smart groups they have that filter on the "Email On Hold" field.

- **[dev/mail#23](https://lab.civicrm.org/dev/mail/issues/23) Bounce processing
  doesn't catch pattern 'user doesn't exist'
  ([13200](https://github.com/civicrm/civicrm-core/pull/13200))**

  This change makes it so that the bounce pattern 'user doesn't exist' is
  registered as an invalid bounce type. ### Drupal Integration

- **[dev/drupal#31](https://lab.civicrm.org/dev/drupal/issues/31) CiviMember
- Role sync is no longer syncing Pending memberships
- ([543](https://github.com/civicrm/civicrm-drupal/pull/543))**

  This change fixes a bug where the drupal module CiviMember Role sync was not
  syncing memberships for the role sync rule "Add when status is set to
  Pending" so that this rule works as expected.

## <a name="misc"></a>Miscellany

- **(NFC) Add in unit test of dev/core#93 expansion to allow order by of more t…
  ([13077](https://github.com/civicrm/civicrm-core/pull/13077))**

- **Merge 5.7 to master
  ([13069](https://github.com/civicrm/civicrm-core/pull/13069))**

- **5.7.0 release notes
  ([12944](https://github.com/civicrm/civicrm-core/pull/12944))**

- **Fix test name because it is not running & doesn't pass :-(
  ([13143](https://github.com/civicrm/civicrm-core/pull/13143))**

- **Trivial code cleanup
  ([13166](https://github.com/civicrm/civicrm-core/pull/13166))**

- **[NFC] Extract getUserCheckSum function
  ([13167](https://github.com/civicrm/civicrm-core/pull/13167))**

- **(NFC) Regenerate DAO Checksums after changes to codegen
  ([13204](https://github.com/civicrm/civicrm-core/pull/13204))**

- **5.8 to master
  ([13235](https://github.com/civicrm/civicrm-core/pull/13235))**

- **5.8 ([13229](https://github.com/civicrm/civicrm-core/pull/13229))**

- **5.8 to master
  ([13145](https://github.com/civicrm/civicrm-core/pull/13145))**

- **5.8 ([13135](https://github.com/civicrm/civicrm-core/pull/13135))**

- **5.8 to master
  ([13130](https://github.com/civicrm/civicrm-core/pull/13130))**

- **5.8 ([13109](https://github.com/civicrm/civicrm-core/pull/13109))**

- **5.8 ([13106](https://github.com/civicrm/civicrm-core/pull/13106))**

- **5.8 ([13184](https://github.com/civicrm/civicrm-core/pull/13184))**

- **5.8 ([13182](https://github.com/civicrm/civicrm-core/pull/13182))**

- **5.8 ([13193](https://github.com/civicrm/civicrm-core/pull/13193))**

- **5.8 to master
  ([13094](https://github.com/civicrm/civicrm-core/pull/13094))**

- **5.8 to master
  ([13154](https://github.com/civicrm/civicrm-core/pull/13154))**

- **5.8 to master
  ([13152](https://github.com/civicrm/civicrm-core/pull/13152))**

- **5.8 to master
  ([231](https://github.com/civicrm/civicrm-packages/pull/231))**

- **5.8 ([13080](https://github.com/civicrm/civicrm-core/pull/13080))**

- **5.8 to master
  ([13071](https://github.com/civicrm/civicrm-core/pull/13071))**

- **Export code cleanup -remove meaningless code
  ([13083](https://github.com/civicrm/civicrm-core/pull/13083))**

- **Export code cleanup - remove silly function
  ([13122](https://github.com/civicrm/civicrm-core/pull/13122))**

- **Export class cleanup - remove some unnecessary code
  ([13120](https://github.com/civicrm/civicrm-core/pull/13120))**

- **Test support for fixing dev/core#397 including adding Rule api
  ([13179](https://github.com/civicrm/civicrm-core/pull/13179))**

- **Unit test set up tweak - Set trxn_id & invoice_id in tests as needed rather
  than by default.
  ([13146](https://github.com/civicrm/civicrm-core/pull/13146))**

- **[REF] Rename recently added getUrlVariables getFormVariables function…
  ([13225](https://github.com/civicrm/civicrm-core/pull/13225))**

- **[REF] refactor shared search functions in pre-Process
  ([13210](https://github.com/civicrm/civicrm-core/pull/13210))**

- **(REF) Allow subclasses of AbstractTokenSubscriber to override the
  determination of active tokens.
  ([13186](https://github.com/civicrm/civicrm-core/pull/13186))**

## <a name="credits"></a>Credits

This release was developed by the following code authors:

AGH Strategies - Alice Frumin, Andrew Hunt, Eli Lisseck; Agileware - Agileware Team, Francis Whittle; Australian Greens - Seamus Lee; Christian Wach; CiviCRM - Coleman Watts, Tim Otten; CompuCorp - Omar Abu Hussein; Coop SymbioTIC - Guillaume Boudrias, Mathieu Lutfy; Francesc Bassas i Bullich; Fuzion - Jitendra Purohit; Ginkgo Street Labs - Frank Gómez; JMA Consulting - Joe Murray, Monish Deb; John Kingsnorth; Joinery - Allen Shaw; Ken West; Lemniscus - Noah Miller; MJW Consulting - Matthew Wire; Pradeep Nayak; ray-wright; Squiffle Consulting - Aidan Saunders; thomst; tiotsop01; Wikimedia Foundation - Eileen McNaughton, Elliott Eggleston

Most authors also reviewed code for this release; in addition, the following
reviewers contributed their comments:

AGH Strategies - Alice Frumin, Andrew Hunt, Eli Lisseck; Australian Greens - Seamus Lee; Brooks Digital - Spencer Brooks; chandana; Christian Wach; civibot[bot]; CiviCRM - Coleman Watts, Tim Otten; CompuCorp - Alessandro Verdura, Omar Abu Hussein; Coop SymbioTIC - Guillaume Boudrias; dyguk; Francesc Bassas i Bullich; Fuzion - Jitendra Purohit, Luke Stewart; iXiam - Luciano Spiegel; JMA Consulting - Monish Deb; Joinery - Allen Shaw; Korlon - Stuart Gaston; Lighthouse Design and Consulting - Brian Shaughnessy; Megaphone Technology Consulting - Jon Goldberg; MJW Consulting - Matthew Wire; pbarmak; Pradeep Nayak; ray-wright; Squiffle Consulting - Aidan Saunders; Tadpole Collective - Kevin Cristiano; Wikimedia Foundation - Eileen McNaughton

## <a name="feedback"></a>Feedback

These release notes are edited by Alice Frumin and Andrew Hunt.  If you'd like
to provide feedback on them, please log in to https://chat.civicrm.org/civicrm
and contact `@agh1`.
